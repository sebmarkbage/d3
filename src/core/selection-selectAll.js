var D3Selection = require("./selection"),
    d3_selectionPrototype = D3Selection._selectionPrototype,
    d3_array = require("./array")._array,
    d3_selection = D3Selection._selection,
    d3_selectAll = D3Selection._selectAll;

d3_selectionPrototype.selectAll = function(selector) {
  var subgroups = [],
      subgroup,
      node;

  if (typeof selector !== "function") selector = d3_selection_selectorAll(selector);

  for (var j = -1, m = this.length; ++j < m;) {
    for (var group = this[j], i = -1, n = group.length; ++i < n;) {
      if (node = group[i]) {
        subgroups.push(subgroup = d3_array(selector.call(node, node.__data__, i)));
        subgroup.parentNode = node;
      }
    }
  }

  return d3_selection(subgroups);
};

function d3_selection_selectorAll(selector) {
  return function() {
    return d3_selectAll(selector, this);
  };
}

exports._selectorAll = d3_selection_selectorAll;
